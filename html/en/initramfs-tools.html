<html>
<head><meta charset=utf-8/>
<title>initramfs-tools - an introduction to writing scripts for mkinitramfs</title></head>
<body><pre>

INITRAMFS-TOOLS(8)         mkinitramfs script overview        INITRAMFS-TOOLS(8)



NAME
       initramfs-tools - an introduction to writing scripts for mkinitramfs


DESCRIPTION
       initramfs-tools  has one main script and two different sets of subscripts
       which will be used during different phases of execution.  Each  of  these
       will  be  discussed  separately  below with the help of an imaginary tool
       which performs a frobnication of a lvm partition prior  to  mounting  the
       root partition.


Kernel Command Line
       The root filesystem used by the kernel is specified by the boot loader as
       always. The traditional  root=/dev/sda1  style  device  specification  is
       allowed.  If  a  label is used, as in root=LABEL=rootPart the initrd will
       search all available devices for a filesystem with the appropriate label,
       and  mount that device as the root filesystem.  root=UUID=uuidnumber will
       mount the partition with that UUID as the root filesystem.


   Standard
        init= &quot;&lt;path to real init&gt;&quot;
              the binary to hand over execution to on  the  root  fs  after  the
              initramfs scripts are done.


        root= &quot;&lt;path to blockdevice&gt;&quot;
              the device node to mount as the root file system.  The recommended
              usage is to specify the UUID as followed &quot;root=UUID=xxx&quot;.


        rootfstype
              set the root file system type.


        rootdelay
              set delay in seconds. Determines how long mountroot waits for root
              to appear.  The default is 180 seconds.


        rootflags
              set the file system mount option string.


        nfsroot
              can  be  either &quot;auto&quot; to try to get the relevant information from
              DHCP or a string of the form NFSSERVER:NFSPATH  or  NFSSERVER:NFS&#8208;
              PATH:NFSOPTS.   Use  root=/dev/nfs  for NFS to kick to in. NFSOPTS
              can be looked up in nfs(5).


        ip    tells how to configure the ip address. Allows one  to  specify  an
              different   NFS  server  than  the  DHCP  server.  See  Documenta&#8208;
              tion/filesystems/nfsroot.txt  in  any  recent  Linux  source   for
              details. Optional parameter for NFS root.


        BOOTIF
              is  a mac address in pxelinux format with leading &quot;01-&quot; and &quot;-&quot; as
              separations.  pxelinux passes mac address of network card used  to
              PXE boot on with this bootarg.


        boot  either  local or NFS (affects which initramfs scripts are run, see
              the &quot;Subdirectories&quot; section under boot scripts).


        resume
              On install initramfs-tools tries to autodetect the  resume  parti&#8208;
              tion. On success the RESUME variable is written to /etc/initramfs-
              tools/conf.d/resume.  The boot variable noresume overrides it.


        resume_offset
              Specify the offset from the partition given by &quot;resume=&quot; at  which
              the swap header of the swap file is located.


        quiet reduces the amount of text output to the console during boot.


        ro    mounts the rootfs read-only.


        rw    mounts the rootfs read-write.


        blacklist
              disables  load  of  specific  modules.  Use blacklist=module1,mod&#8208;
              ule2,module3 bootparameter.


   Debug
        panic sets an timeout on panic.  panic=&lt;sec&gt; is  a  documented  security
              feature: it disables the debug shell.


        debug generates    lots    of    output.    It    writes    a   log   to
              /run/initramfs/initramfs.debug.   Instead  when  invoked  with  an
              arbitrary  argument output is written to console.  Use for example
              &quot;debug=vc&quot;.


        break spawns a shell in the initramfs image  at  chosen  run-time  (top,
              modules,  premount,  mount, mountroot, bottom, init).  The default
              is premount without any arg.  Beware  that  if  both  &quot;panic&quot;  and
              &quot;break&quot;  are  present,  initramfs  will  not  spawn any shells but
              reboot instead.


        netconsole
              loads netconsole linux modules with the chosen args.


        all_generic_ide
              loads generic IDE/ATA chipset support on boot.



HOOK SCRIPTS
       Valid boot and hook scripts names consist solely of  alphabetics,  numer&#8208;
       ics, dashes and underscores. Other scripts are discarded.


   Hook scripts
       These are used when an initramfs image is created and not included in the
       image itself. They can however cause files to be included in  the  image.
       Hook scripts are executed under errexit. Thus a hook script can abort the
       mkinitramfs build on possible errors (exitcode != 0).


   Boot scripts
       These are included in the initramfs image and  normally  executed  during
       kernel  boot  in  the early user-space before the root partition has been
       mounted.


       Hooks can be found in two  places:  /usr/share/initramfs-tools/hooks  and
       /etc/initramfs-tools/hooks.  They  are  executed during generation of the
       initramfs-image and are responsible for including all the necessary  com&#8208;
       ponents  in  the  image itself. No guarantees are made as to the order in
       which the different scripts are executed unless the prereqs are setup  in
       the  script.   Please  notice that PREREQ is only honored inside a single
       directory.   So  first  the  scripts  in  /usr/share/initramfs-tools  are
       ordered  according  to their PREREQ values and executed. Then all scripts
       in /etc/initramfs-tools are ordered according to their PREREQ values  and
       executed.  This  mean  that  currently  there is no possibility to have a
       local script (/etc/initramfs-tools) get  executed  before  one  from  the
       package (/usr/share/initramfs-tools).


   Header
       In  order to support prereqs, each script should begin with the following
       lines:

              #!/bin/sh
              PREREQ=&quot;&quot;
              prereqs()
              {
                   echo &quot;$PREREQ&quot;
              }

              case $1 in
              prereqs)
                   prereqs
                   exit 0
                   ;;
              esac

              . /usr/share/initramfs-tools/hook-functions
              # Begin real processing below this line

       For example, if you are writing a new hook script which  relies  on  lvm,
       the  line  starting  with  PREREQ should be changed to PREREQ=&quot;lvm&quot; which
       will ensure that the lvm hook script is run before your custom script.


   Help functions
       /usr/share/initramfs-tools/hook-functions contains a number of  functions
       which deal with some common tasks in a hook script:

              manual_add_modules adds a module (and any modules which it depends
              on) to the initramfs image.

              Example: manual_add_modules isofs


              add_modules_from_file reads a file containing a  list  of  modules
              (one  per  line)  to be added to the initramfs image. The file can
              contain comments (lines starting with #) and arguments to the mod&#8208;
              ules  by writing the arguments on the same line as the name of the
              module.
&#12;              Example: add_modules_from_file /tmp/modlist


              force_load adds a module (and its dependencies) to  the  initramfs
              image  and also unconditionally loads the module during boot. Also
              supports passing arguments to the module by listing them after the
              module name.

              Example: force_load cdrom debug=1


              copy_modules_dir  copies an entire module directory from /lib/mod&#8208;
              ules/KERNELVERSION/ into the initramfs image.

              Example: copy_modules_dir kernel/drivers/ata


   Including binaries
       If you need to copy binaries to the initramfs module, a command like this
       should be used:

              copy_exec /sbin/mdadm /sbin

       mkinitramfs  will  automatically  detect  which  libraries the executable
       depends on and copy them to the initramfs. This means that most  executa&#8208;
       bles, unless compiled with klibc, will automatically include glibc in the
       image which will increase its size by several hundred kilobytes.


   Exported variables
       mkinitramfs sets several variables for the hook scripts environment.


        MODULESDIR
              corresponds to the linux-2.6 modules dir.

        version
              is the $(uname -r) linux-2.6 version against mkinitramfs is run.

        CONFDIR
              is the path of the used initramfs-tools configurations.

        DESTDIR
              is the root path of the newly build initramfs.

        DPKG_ARCH
              allows arch specific hook additions.

        verbose
              corresponds to the verbosity of the update-initramfs run.

        KEYMAP
              sets if a keymap needs to be added to initramfs.

        MODULES
              specifies which kind of modules should land  on  initramfs.   This
              setting shouldn&apos;t be overridden by hook script, but can guide them
              on how much they need to include on initramfs.



BOOT SCRIPTS
       Similarly to hook scripts, boot  scripts  can  be  found  in  two  places
       /usr/share/initramfs-tools/scripts/   and  /etc/initramfs-tools/scripts/.
       There are a number of subdirectories to these two directories which  con&#8208;
       trol the boot stage at which the scripts are executed.


   Header
       Like  for  hook scripts, there are no guarantees as to the order in which
       the different scripts in one subdirectory  (see  &quot;Subdirectories&quot;  below)
       are executed. In order to define a certain order, a similar header as for
       hook scripts should be used:

              #!/bin/sh
              PREREQ=&quot;&quot;
              prereqs()
              {
                   echo &quot;$PREREQ&quot;
              }

              case $1 in
              prereqs)
                   prereqs
                   exit 0
                   ;;
              esac

       Where PREREQ is modified to list other scripts in the  same  subdirectory
       if necessary.


   Help functions
       A  number  of functions (mostly dealing with output) are provided to boot
       scripts in /scripts/functions :


              log_success_msg Logs a success message

              Example: log_success_msg &quot;Frobnication successful&quot;


              log_failure_msg Logs a failure message

              Example: log_failure_msg &quot;Frobnication component froobz missing&quot;


              log_warning_msg Logs a warning message

              Example: log_warning_msg &quot;Only partial frobnication possible&quot;


              log_begin_msg Logs a message that some processing step has begun


              log_end_msg Logs a message that some processing step is finished

              Example:

                     log_begin_msg &quot;Frobnication begun&quot;
                     # Do something
                     log_end_msg


              panic Logs an error message and executes a shell in the  initramfs
              image to allow the user to investigate the situation.

              Example: panic &quot;Frobnication failed&quot;


   Subdirectories
       Both  /usr/share/initramfs-tools/scripts and /etc/initramfs-tools/scripts
       contains the following subdirectories.


              init-top the scripts in this directory are the first scripts to be
              executed  after  sysfs and procfs have been mounted.  It also runs
              the udev hook for populating the /dev tree (udev will keep running
              until init-bottom).


              init-premount   happens  after  modules  specified  by  hooks  and
              /etc/initramfs-tools/modules have been loaded.


              local-top OR nfs-top After these scripts have been  executed,  the
              root  device node is expected to be present (local) or the network
              interface is expected to be usable (NFS).


              local-premount OR nfs-premount are run after  the  sanity  of  the
              root device has been verified (local) or the network interface has
              been brought up (NFS), but before the  actual  root  fs  has  been
              mounted.


              local-bottom  OR  nfs-bottom  are  run  after  the rootfs has been
              mounted (local) or the NFS root share has been mounted.


              init-bottom are the last scripts to be executed before procfs  and
              sysfs are moved to the real rootfs and execution is turned over to
              the init binary which should now be found in the  mounted  rootfs.
              udev is stopped.


   Boot parameters
              /conf/param.conf  allows boot scripts to change exported variables
              that are listed on top of init. Write the new  values  to  it.  It
              will be sourced after an boot script run if it exists.



EXAMPLES
   Hook script
       An  example hook script would look something like this (and would usually
       be placed in /etc/initramfs-tools/hooks/frobnicate):

              #!/bin/sh
              # Example frobnication hook script

              PREREQ=&quot;lvm&quot;
              prereqs()
              {
                   echo &quot;$PREREQ&quot;
              }

              case $1 in
              prereqs)
                   prereqs
                   exit 0
                   ;;
              esac

              . /usr/share/initramfs-tools/hook-functions
              # Begin real processing below this line

              if [ ! -x &quot;/sbin/frobnicate&quot; ]; then
                   exit 0
              fi

              force_load frobnicator interval=10
              cp /sbin/frobnicate &quot;${DESTDIR}/sbin&quot;
              exit 0


   Boot script
       An example boot script would look something like this (and would  usually
       be placed in /etc/initramfs-tools/scripts/local-top/frobnicate):

              #!/bin/sh
              # Example frobnication boot script

              PREREQ=&quot;lvm&quot;
              prereqs()
              {
                   echo &quot;$PREREQ&quot;
              }

              case $1 in
              prereqs)
                   prereqs
                   exit 0
                   ;;
              esac

              . /scripts/functions
              # Begin real processing below this line
              if [ ! -x &quot;/sbin/frobnicate&quot; ]; then
                   panic &quot;Frobnication executable not found&quot;
              fi

              if [ ! -e &quot;/dev/mapper/frobb&quot; ]; then
                   panic &quot;Frobnication device not found&quot;
              fi

              log_begin_msg &quot;Starting frobnication&quot;
              /sbin/frobnicate &quot;/dev/mapper/frobb&quot; || panic &quot;Frobnication failed&quot;
              log_end_msg

              exit 0


   Exported variables
       init sets several variables for the boot scripts environment.


        ROOT  corresponds  to  the root boot option.  Advanced boot scripts like
              cryptsetup or live-initramfs need to play tricks.  Otherwise  keep
              it alone.

        ROOTDELAY, ROOTFLAGS, ROOTFSTYPE, IP
              corresponds  to  the  rootdelay,  rootflags, rootfstype or ip boot
              option.

        DPKG_ARCH
              allows arch specific boot actions.

        blacklist, panic, quiet, resume, noresume, resume_offset
              set according relevant boot option.

        break Useful for manual intervention during setup  and  coding  an  boot
              script.

        REASON
              Argument passed to the panic helper function.  Use to find out why
              you landed in the initramfs shell.

        init  passes the path to init(8) usually /sbin/init.

        readonly
              is the default  for  mounting  the  root  corresponds  to  the  ro
              bootarg.  Overridden by rw bootarg.

        rootmnt
              is the path where root gets mounted usually /root.

        debug indicates that a debug log is captured for further investigation.



DEBUG
       It is easy to check the generated initramfs for its content. One may need
       to double-check if it contains the relevant binaries, libs or modules:
              mkdir tmp/initramfs
              cd tmp/initramfs
              gunzip -c /boot/initrd.img-2.6.18-1-686 | \
              cpio -i -d -H newc --no-absolute-filenames



AUTHOR
       The initramfs-tools are written by Maximilian  Attems  &lt;maks@debian.org&gt;,
       Jeff Bailey &lt;jbailey@raspberryginger.com&gt; and numerous others.

       This  manual  was written by David  H&#228;rdeman &lt;david@hardeman.nu&gt;, updated
       by Maximilian Attems &lt;maks@debian.org&gt;.


SEE ALSO
        initramfs.conf(5), mkinitramfs(8), update-initramfs(8).



Linux                              2010/09/23                 INITRAMFS-TOOLS(8)

</pre></body></html>
