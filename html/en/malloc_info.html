<html>
<head><meta charset=utf-8/>
<title>malloc_info - export malloc state to a stream</title></head>
<body><pre>

MALLOC_INFO(3)              Linux Programmer&apos;s Manual             MALLOC_INFO(3)



NAME
       malloc_info - export malloc state to a stream

SYNOPSIS
       #include &lt;malloc.h&gt;

       int malloc_info(int options, FILE *fp);

DESCRIPTION
       The  malloc_info() function exports an XML string that describes the cur&#8208;
       rent state of the memory-allocation implementation in  the  caller.   The
       string  is  printed  on the file stream fp.  The exported string includes
       information about all arenas (see malloc(3)).

       As currently implemented, options must be zero.

RETURN VALUE
       On success, malloc_info() returns 0; on error, it returns -1.

ERRORS
       EINVAL options was nonzero.

VERSIONS
       malloc_info(3) was added to glibc in version 2.10.

CONFORMING TO
       This function is a GNU extension.

NOTES
       The memory-allocation information is provided as an  XML  string  (rather
       than a C structure) because the information may change over time (accord&#8208;
       ing to changes in the underlying implementation).  The output XML  string
       includes a version field.

       The  open_memstream(3)  function  can  be used to send the output of mal&#8208;
       loc_info() directly into a buffer in memory, rather than to a file.

       The malloc_info() function is designed to address  deficiencies  in  mal&#8208;
       loc_stats(3) and mallinfo(3).

EXAMPLE
       The  program  below takes up to four command-line arguments, of which the
       first three are mandatory.  The first argument specifies  the  number  of
       threads  that  the  program should create.  All of the threads, including
       the main thread, allocate the number of blocks of memory specified by the
       second  argument.   The third argument controls the size of the blocks to
       be allocated.  The main thread creates blocks of this  size,  the  second
       thread  created  by  the program allocates blocks of twice this size, the
       third thread allocates blocks of three times this size, and so on.

       The program calls malloc_info() twice to  display  the  memory-allocation
       state.  The first call takes place before any threads are created or mem&#8208;
       ory allocated.  The second call is performed after all threads have allo&#8208;
       cated memory.

       In the following example, the command-line arguments specify the creation
       of one additional thread, and both the main  thread  and  the  additional
       thread  allocate 10000 blocks of memory.  After the blocks of memory have
       been allocated, malloc_info() shows the state of two allocation arenas.

           $ getconf GNU_LIBC_VERSION
           glibc 2.13
           $ ./a.out 1 10000 100
           ============ Before allocating blocks ============
           &lt;malloc version=&quot;1&quot;&gt;
           &lt;heap nr=&quot;0&quot;&gt;
           &lt;sizes&gt;
           &lt;/sizes&gt;
           &lt;total type=&quot;fast&quot; count=&quot;0&quot; size=&quot;0&quot;/&gt;
           &lt;total type=&quot;rest&quot; count=&quot;0&quot; size=&quot;0&quot;/&gt;
           &lt;system type=&quot;current&quot; size=&quot;135168&quot;/&gt;
           &lt;system type=&quot;max&quot; size=&quot;135168&quot;/&gt;
           &lt;aspace type=&quot;total&quot; size=&quot;135168&quot;/&gt;
           &lt;aspace type=&quot;mprotect&quot; size=&quot;135168&quot;/&gt;
           &lt;/heap&gt;
           &lt;total type=&quot;fast&quot; count=&quot;0&quot; size=&quot;0&quot;/&gt;
           &lt;total type=&quot;rest&quot; count=&quot;0&quot; size=&quot;0&quot;/&gt;
           &lt;system type=&quot;current&quot; size=&quot;135168&quot;/&gt;
           &lt;system type=&quot;max&quot; size=&quot;135168&quot;/&gt;
           &lt;aspace type=&quot;total&quot; size=&quot;135168&quot;/&gt;
           &lt;aspace type=&quot;mprotect&quot; size=&quot;135168&quot;/&gt;
           &lt;/malloc&gt;

           ============ After allocating blocks ============
           &lt;malloc version=&quot;1&quot;&gt;
           &lt;heap nr=&quot;0&quot;&gt;
           &lt;sizes&gt;
           &lt;/sizes&gt;
           &lt;total type=&quot;fast&quot; count=&quot;0&quot; size=&quot;0&quot;/&gt;
           &lt;total type=&quot;rest&quot; count=&quot;0&quot; size=&quot;0&quot;/&gt;
           &lt;system type=&quot;current&quot; size=&quot;1081344&quot;/&gt;
           &lt;system type=&quot;max&quot; size=&quot;1081344&quot;/&gt;
           &lt;aspace type=&quot;total&quot; size=&quot;1081344&quot;/&gt;
           &lt;aspace type=&quot;mprotect&quot; size=&quot;1081344&quot;/&gt;
           &lt;/heap&gt;
           &lt;heap nr=&quot;1&quot;&gt;
           &lt;sizes&gt;
           &lt;/sizes&gt;
           &lt;total type=&quot;fast&quot; count=&quot;0&quot; size=&quot;0&quot;/&gt;
           &lt;total type=&quot;rest&quot; count=&quot;0&quot; size=&quot;0&quot;/&gt;
           &lt;system type=&quot;current&quot; size=&quot;1032192&quot;/&gt;
           &lt;system type=&quot;max&quot; size=&quot;1032192&quot;/&gt;
           &lt;aspace type=&quot;total&quot; size=&quot;1032192&quot;/&gt;
           &lt;aspace type=&quot;mprotect&quot; size=&quot;1032192&quot;/&gt;
           &lt;/heap&gt;
           &lt;total type=&quot;fast&quot; count=&quot;0&quot; size=&quot;0&quot;/&gt;
           &lt;total type=&quot;rest&quot; count=&quot;0&quot; size=&quot;0&quot;/&gt;
           &lt;system type=&quot;current&quot; size=&quot;2113536&quot;/&gt;
           &lt;system type=&quot;max&quot; size=&quot;2113536&quot;/&gt;
           &lt;aspace type=&quot;total&quot; size=&quot;2113536&quot;/&gt;
           &lt;aspace type=&quot;mprotect&quot; size=&quot;2113536&quot;/&gt;
           &lt;/malloc&gt;

   Program source
       #include &lt;unistd.h&gt;
       #include &lt;stdlib.h&gt;
       #include &lt;pthread.h&gt;
       #include &lt;malloc.h&gt;
       #include &lt;errno.h&gt;

       static size_t blockSize;
       static int numThreads, numBlocks;

       #define errExit(msg)    do { perror(msg); exit(EXIT_FAILURE); \
                               } while (0)

       static void *
       thread_func(void *arg)
       {
           int j;
           int tn = (int) arg;

           /* The multiplier &apos;(2 + tn)&apos; ensures that each thread (including
              the main thread) allocates a different amount of memory */

           for (j = 0; j &lt; numBlocks; j++)
               if (malloc(blockSize * (2 + tn)) == NULL)
                   errExit(&quot;malloc-thread&quot;);

           sleep(100);         /* Sleep until main thread terminates */
           return NULL;
       }

       int
       main(int argc, char *argv[])
       {
           int j, tn, sleepTime;
           pthread_t *thr;

           if (argc &lt; 4) {
               fprintf(stderr,
                       &quot;%s num-threads num-blocks block-size [sleep-time]\n&quot;,
                       argv[0]);
               exit(EXIT_FAILURE);
           }

           numThreads = atoi(argv[1]);
           numBlocks = atoi(argv[2]);
           blockSize = atoi(argv[3]);
           sleepTime = (argc &gt; 4) ? atoi(argv[4]) : 0;

           thr = calloc(numThreads, sizeof(pthread_t));
           if (thr == NULL)
               errExit(&quot;calloc&quot;);

           printf(&quot;============ Before allocating blocks ============\n&quot;);
           malloc_info(0, stdout);

           /* Create threads that allocate different amounts of memory */

           for (tn = 0; tn &lt; numThreads; tn++) {
               errno = pthread_create(&amp;thr[tn], NULL, thread_func,
                                      (void *) tn);
               if (errno != 0)
                   errExit(&quot;pthread_create&quot;);

               /* If we add a sleep interval after the start-up of each
                  thread, the threads likely won&apos;t contend for malloc
                  mutexes, and therefore additional arenas won&apos;t be
                  allocated (see malloc(3)). */

               if (sleepTime &gt; 0)
                   sleep(sleepTime);
           }

           /* The main thread also allocates some memory */

           for (j = 0; j &lt; numBlocks; j++)
               if (malloc(blockSize) == NULL)
                   errExit(&quot;malloc&quot;);

           sleep(2);           /* Give all threads a chance to
                                  complete allocations */
&#12;           printf(&quot;\n============ After allocating blocks ============\n&quot;);
           malloc_info(0, stdout);

           exit(EXIT_SUCCESS);
       }

SEE ALSO
       mallinfo(3), malloc(3), malloc_stats(3), mallopt(3), open_memstream(3)

COLOPHON
       This page is part of release 3.44 of  the  Linux  man-pages  project.   A
       description  of the project, and information about reporting bugs, can be
       found at http://www.kernel.org/doc/man-pages/.



GNU                                2012-04-28                     MALLOC_INFO(3)

</pre></body></html>
