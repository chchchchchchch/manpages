<html>
<head><meta charset=utf-8/>
<title>mq_notify - register for notification when a message is available</title></head>
<body><pre>

MQ_NOTIFY(3)                Linux Programmer&apos;s Manual               MQ_NOTIFY(3)



NAME
       mq_notify - register for notification when a message is available

SYNOPSIS
       #include &lt;mqueue.h&gt;

       int mq_notify(mqd_t mqdes, const struct sigevent *sevp);

       Link with -lrt.

DESCRIPTION
       mq_notify()  allows  the  calling  process  to register or unregister for
       delivery of an asynchronous notification when a new  message  arrives  on
       the empty message queue referred to by the descriptor mqdes.

       The  sevp argument is a pointer to a sigevent structure.  For the defini&#8208;
       tion and general details of this structure, see sigevent(7).

       If sevp is a non-NULL pointer, then  mq_notify()  registers  the  calling
       process  to  receive message notification.  The sigev_notify field of the
       sigevent structure to which sevp points specifies how notification is  to
       be performed.  This field has one of the following values:

       SIGEV_NONE
              A  &quot;null&quot;  notification:  the calling process is registered as the
              target for notification, but when a message arrives, no  notifica&#8208;
              tion is sent.

       SIGEV_SIGNAL
              Notify the process by sending the signal specified in sigev_signo.
              See sigevent(7) for general details.  The  si_code  field  of  the
              siginfo_t  structure will be set to SI_MESGQ.  In addition, si_pid
              will be set to the PID of the process that sent the  message,  and
              si_uid will be set to the real user ID of the sending process.

       SIGEV_THREAD
              Upon  message delivery, invoke sigev_notify_function as if it were
              the start function of a new thread.  See sigevent(7) for details.

       Only one process can be registered to receive notification from a message
       queue.

       If  sevp  is  NULL,  and  the  calling process is currently registered to
       receive notifications for this message queue, then  the  registration  is
       removed; another process can then register to receive a message notifica&#8208;
       tion for this queue.

       Message notification only occurs when a new message arrives and the queue
       was previously empty.  If the queue was not empty at the time mq_notify()
       was called, then a notification will only occur after the queue  is  emp&#8208;
       tied and a new message arrives.

       If  another  process or thread is waiting to read a message from an empty
       queue using mq_receive(3), then any message notification registration  is
       ignored:  the  message  is  delivered  to  the  process or thread calling
       mq_receive(3), and  the  message  notification  registration  remains  in
       effect.

       Notification  occurs once: after a notification is delivered, the notifi&#8208;
       cation registration is removed, and another process can register for mes&#8208;
       sage  notification.   If  the notified process wishes to receive the next
       notification, it can use mq_notify() to request a  further  notification.
       This  should  be done before emptying all unread messages from the queue.
       (Placing the queue in nonblocking mode is useful for emptying  the  queue
       of messages without blocking once it is empty.)

RETURN VALUE
       On  success  mq_notify()  returns 0; on error, -1 is returned, with errno
       set to indicate the error.

ERRORS
       EBADF  The descriptor specified in mqdes is invalid.

       EBUSY  Another process has already registered to receive notification for
              this message queue.

       EINVAL sevp-&gt;sigev_notify   is  not  one  of  the  permitted  values;  or
              sevp-&gt;sigev_notify is SIGEV_SIGNAL and sevp-&gt;sigev_signo is not  a
              valid signal number.

       ENOMEM Insufficient memory.

       POSIX.1-2008  says that an implementation may generate an EINVAL error if
       sevp is NULL, and the caller is not currently registered to receive noti&#8208;
       fications for the queue mqdes.

CONFORMING TO
       POSIX.1-2001.

EXAMPLE
       The  following  program  registers a notification request for the message
       queue named in its command-line argument.  Notification is  performed  by
       creating  a  thread.  The thread executes a function which reads one mes&#8208;
       sage from the queue and then terminates the process.

       #include &lt;pthread.h&gt;
       #include &lt;mqueue.h&gt;
       #include &lt;stdio.h&gt;
       #include &lt;stdlib.h&gt;
       #include &lt;unistd.h&gt;

       #define handle_error(msg) \
           do { perror(msg); exit(EXIT_FAILURE); } while (0)

       static void                     /* Thread start function */
       tfunc(union sigval sv)
       {
           struct mq_attr attr;
           ssize_t nr;
           void *buf;
           mqd_t mqdes = *((mqd_t *) sv.sival_ptr);

           /* Determine max. msg size; allocate buffer to receive msg */

           if (mq_getattr(mqdes, &amp;attr) == -1)
               handle_error(&quot;mq_getattr&quot;);
           buf = malloc(attr.mq_msgsize);
           if (buf == NULL)
               handle_error(&quot;malloc&quot;);

           nr = mq_receive(mqdes, buf, attr.mq_msgsize, NULL);
           if (nr == -1)
               handle_error(&quot;mq_receive&quot;);

           printf(&quot;Read %ld bytes from MQ\n&quot;, (long) nr);
           free(buf);
           exit(EXIT_SUCCESS);         /* Terminate the process */
       }

       int
       main(int argc, char *argv[])
       {
           mqd_t mqdes;
           struct sigevent sev;

           if (argc != 2) {
            fprintf(stderr, &quot;Usage: %s &lt;mq-name&gt;\n&quot;, argv[0]);
            exit(EXIT_FAILURE);
           }

           mqdes = mq_open(argv[1], O_RDONLY);
           if (mqdes == (mqd_t) -1)
               handle_error(&quot;mq_open&quot;);

           sev.sigev_notify = SIGEV_THREAD;
           sev.sigev_notify_function = tfunc;
           sev.sigev_notify_attributes = NULL;
           sev.sigev_value.sival_ptr = &amp;mqdes;   /* Arg. to thread func. */
           if (mq_notify(mqdes, &amp;sev) == -1)
               handle_error(&quot;mq_notify&quot;);

           pause();    /* Process will be terminated by thread function */
       }

SEE ALSO
       mq_close(3),  mq_getattr(3),   mq_open(3),   mq_receive(3),   mq_send(3),
       mq_unlink(3), mq_overview(7), sigevent(7)

COLOPHON
       This  page  is  part  of  release 3.44 of the Linux man-pages project.  A
       description of the project, and information about reporting bugs, can  be
       found at http://www.kernel.org/doc/man-pages/.



Linux                              2010-10-04                       MQ_NOTIFY(3)

</pre></body></html>
