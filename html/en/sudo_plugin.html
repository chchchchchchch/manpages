<html>
<head><meta charset=utf-8/>
<title>sudo_plugin - Sudo Plugin API</title></head>
<body><pre>

SUDO_PLUGIN(8)                MAINTENANCE COMMANDS                SUDO_PLUGIN(8)



NAME
       sudo_plugin - Sudo Plugin API

DESCRIPTION
       Starting with version 1.8, sudo supports a plugin API for policy and
       session logging.  By default, the sudoers policy plugin and an associated
       I/O logging plugin are used.  Via the plugin API, sudo can be configured
       to use alternate policy and/or I/O logging plugins provided by third
       parties.  The plugins to be used are specified via the /etc/sudo.conf
       file.

       The API is versioned with a major and minor number.  The minor version
       number is incremented when additions are made.  The major number is
       incremented when incompatible changes are made.  A plugin should be check
       the version passed to it and make sure that the major version matches.

       The plugin API is defined by the sudo_plugin.h header file.

   The sudo.conf File
       The /etc/sudo.conf file contains plugin configuration directives.
       Currently, the only supported keyword is the Plugin directive, which
       causes a plugin plugin to be loaded.

       A Plugin line consists of the Plugin keyword, followed by the symbol_name
       and the path to the shared object containing the plugin.  The symbol_name
       is the name of the struct policy_plugin or struct io_plugin in the plugin
       shared object.  The path may be fully qualified or relative.  If not
       fully qualified it is relative to the /usr/libexec directory.  Any
       additional parameters after the path are passed as options to the
       plugin&apos;s open function.  Lines that don&apos;t begin with Plugin, Path, Debug
       or Set are silently ignored.

       The same shared object may contain multiple plugins, each with a
       different symbol name.  The shared object file must be owned by uid 0 and
       only writable by its owner.  Because of ambiguities that arise from
       composite policies, only a single policy plugin may be specified.  This
       limitation does not apply to I/O plugins.

        #
        # Default /etc/sudo.conf file
        #
        # Format:
        #   Plugin plugin_name plugin_path plugin_options ...
        #   Path askpass /path/to/askpass
        #   Path noexec /path/to/sudo_noexec.so
        #   Debug sudo /var/log/sudo_debug all@warn
        #   Set disable_coredump true
        #
        # The plugin_path is relative to /usr/libexec unless
        #   fully qualified.
        # The plugin_name corresponds to a global symbol in the plugin
        #   that contains the plugin interface structure.
        # The plugin_options are optional.
        #
        Plugin sudoers_policy sudoers.so
        Plugin sudoers_io sudoers.so

   Policy Plugin API
       A policy plugin must declare and populate a policy_plugin struct in the
       global scope.  This structure contains pointers to the functions that
       implement the sudo policy checks.  The name of the symbol should be
       specified in /etc/sudo.conf along with a path to the plugin so that sudo
       can load it.

        struct policy_plugin {
        #define SUDO_POLICY_PLUGIN     1
            unsigned int type; /* always SUDO_POLICY_PLUGIN */
            unsigned int version; /* always SUDO_API_VERSION */
            int (*open)(unsigned int version, sudo_conv_t conversation,
                        sudo_printf_t plugin_printf, char * const settings[],
                        char * const user_info[], char * const user_env[],
                        char * const plugin_options[]);
            void (*close)(int exit_status, int error);
            int (*show_version)(int verbose);
            int (*check_policy)(int argc, char * const argv[],
                                char *env_add[], char **command_info[],
                                char **argv_out[], char **user_env_out[]);
            int (*list)(int argc, char * const argv[], int verbose,
                        const char *list_user);
            int (*validate)(void);
            void (*invalidate)(int remove);
            int (*init_session)(struct passwd *pwd, char **user_env[]);
            void (*register_hooks)(int version,
               int (*register_hook)(struct sudo_hook *hook));
            void (*deregister_hooks)(int version,
               int (*deregister_hook)(struct sudo_hook *hook));
        };

       The policy_plugin struct has the following fields:

       type
           The type field should always be set to SUDO_POLICY_PLUGIN.

       version
           The version field should be set to SUDO_API_VERSION.

           This allows sudo to determine the API version the plugin was built
           against.

       open
            int (*open)(unsigned int version, sudo_conv_t conversation,
                        sudo_printf_t plugin_printf, char * const settings[],
                        char * const user_info[], char * const user_env[],
                        char * const plugin_options[]);

           Returns 1 on success, 0 on failure, -1 if a general error occurred,
           or -2 if there was a usage error.  In the latter case, sudo will
           print a usage message before it exits.  If an error occurs, the
           plugin may optionally call the conversation or plugin_printf function
           with SUDO_CONF_ERROR_MSG to present additional error information to
           the user.

           The function arguments are as follows:

           version
               The version passed in by sudo allows the plugin to determine the
               major and minor version number of the plugin API supported by
               sudo.

           conversation
               A pointer to the conversation function that can be used by the
               plugin to interact with the user (see below).  Returns 0 on
               success and -1 on failure.

           plugin_printf
               A pointer to a printf-style function that may be used to display
               informational or error messages (see below).  Returns the number
               of characters printed on success and -1 on failure.

           settings
               A vector of user-supplied sudo settings in the form of
               &quot;name=value&quot; strings.  The vector is terminated by a NULL
               pointer.  These settings correspond to flags the user specified
               when running sudo.  As such, they will only be present when the
               corresponding flag has been specified on the command line.

               When parsing settings, the plugin should split on the first equal
               sign (&apos;=&apos;) since the name field will never include one itself but
               the value might.

               debug_flags=string
                   A comma-separated list of debug flags that correspond to
                   sudo&apos;s Debug entry in /etc/sudo.conf, if there is one.  The
                   flags are passed to the plugin as they appear in
                   /etc/sudo.conf.  The syntax used by sudo and the sudoers
                   plugin is subsystem@priority but the plugin is free to use a
                   different format so long as it does not include a command ,.

                   For reference, the priorities supported by the sudo front end
                   and sudoers are: crit, err, warn, notice, diag, info, trace
                   and debug.

                   The following subsystems are defined: main, memory, args,
                   exec, pty, utmp, conv, pcomm, util, list, netif, audit, edit,
                   selinux, ldap, match, parser, alias, defaults, auth, env,
                   logging, nss, rbtree, perms, plugin.  The subsystem all
                   includes every subsystem.

                   There is not currently a way to specify a set of debug flags
                   specific to the plugin--the flags are shared by sudo and the
                   plugin.

               debug_level=number
                   This setting has been deprecated in favor of debug_flags.

               runas_user=string
                   The user name or uid to to run the command as, if specified
                   via the -u flag.

               runas_group=string
                   The group name or gid to to run the command as, if specified
                   via the -g flag.

               prompt=string
                   The prompt to use when requesting a password, if specified
                   via the -p flag.

               set_home=bool
                   Set to true if the user specified the -H flag.  If true, set
                   the HOME environment variable to the target user&apos;s home
                   directory.

               preserve_environment=bool
                   Set to true if the user specified the -E flag, indicating
                   that the user wishes to preserve the environment.

               run_shell=bool
                   Set to true if the user specified the -s flag, indicating
                   that the user wishes to run a shell.

               login_shell=bool
                   Set to true if the user specified the -i flag, indicating
                   that the user wishes to run a login shell.
&#12;               implied_shell=bool
                   If the user does not specify a program on the command line,
                   sudo will pass the plugin the path to the user&apos;s shell and
                   set implied_shell to true.  This allows sudo with no
                   arguments to be used similarly to su(1).  If the plugin does
                   not to support this usage, it may return a value of -2 from
                   the check_policy function, which will cause sudo to print a
                   usage message and exit.

               preserve_groups=bool
                   Set to true if the user specified the -P flag, indicating
                   that the user wishes to preserve the group vector instead of
                   setting it based on the runas user.

               ignore_ticket=bool
                   Set to true if the user specified the -k flag along with a
                   command, indicating that the user wishes to ignore any cached
                   authentication credentials.

               noninteractive=bool
                   Set to true if the user specified the -n flag, indicating
                   that sudo should operate in non-interactive mode.  The plugin
                   may reject a command run in non-interactive mode if user
                   interaction is required.

               login_class=string
                   BSD login class to use when setting resource limits and nice
                   value, if specified by the -c flag.

               selinux_role=string
                   SELinux role to use when executing the command, if specified
                   by the -r flag.

               selinux_type=string
                   SELinux type to use when executing the command, if specified
                   by the -t flag.

               bsdauth_type=string
                   Authentication type, if specified by the -a flag, to use on
                   systems where BSD authentication is supported.

               network_addrs=list
                   A space-separated list of IP network addresses and netmasks
                   in the form &quot;addr/netmask&quot;, e.g. &quot;192.168.1.2/255.255.255.0&quot;.
                   The address and netmask pairs may be either IPv4 or IPv6,
                   depending on what the operating system supports.  If the
                   address contains a colon (&apos;:&apos;), it is an IPv6 address, else
                   it is IPv4.

               progname=string
                   The command name that sudo was run as, typically &quot;sudo&quot; or
                   &quot;sudoedit&quot;.

               sudoedit=bool
                   Set to true when the -e flag is is specified or if invoked as
                   sudoedit.  The plugin shall substitute an editor into argv in
                   the check_policy function or return -2 with a usage error if
                   the plugin does not support sudoedit.  For more information,
                   see the check_policy section.

               closefrom=number
                   If specified, the user has requested via the -C flag that
                   sudo close all files descriptors with a value of number or
                   higher.  The plugin may optionally pass this, or another
                   value, back in the command_info list.
&#12;               Additional settings may be added in the future so the plugin
               should silently ignore settings that it does not recognize.

           user_info
               A vector of information about the user running the command in the
               form of &quot;name=value&quot; strings.  The vector is terminated by a NULL
               pointer.

               When parsing user_info, the plugin should split on the first
               equal sign (&apos;=&apos;) since the name field will never include one
               itself but the value might.

               pid=int
                   The process ID of the running sudo process.  Only available
                   starting with API version 1.2

               ppid=int
                   The parent process ID of the running sudo process.  Only
                   available starting with API version 1.2

               sid=int
                   The session ID of the running sudo process or 0 if sudo is
                   not part of a POSIX job control session.  Only available
                   starting with API version 1.2

               pgid=int
                   The ID of the process group that the running sudo process
                   belongs to.  Only available starting with API version 1.2

               tcpgid=int
                   The ID of the forground process group associated with the
                   terminal device associcated with the sudo process or -1 if
                   there is no terminal present.  Only available starting with
                   API version 1.2

               user=string
                   The name of the user invoking sudo.

               euid=uid_t
                   The effective user ID of the user invoking sudo.

               uid=uid_t
                   The real user ID of the user invoking sudo.

               egid=gid_t
                   The effective group ID of the user invoking sudo.

               gid=gid_t
                   The real group ID of the user invoking sudo.

               groups=list
                   The user&apos;s supplementary group list formatted as a string of
                   comma-separated group IDs.

               cwd=string
                   The user&apos;s current working directory.

               tty=string
                   The path to the user&apos;s terminal device.  If the user has no
                   terminal device associated with the session, the value will
                   be empty, as in tty=.

               host=string
                   The local machine&apos;s hostname as returned by the gethostname()
                   system call.
&#12;               lines=int
                   The number of lines the user&apos;s terminal supports.  If there
                   is no terminal device available, a default value of 24 is
                   used.

               cols=int
                   The number of columns the user&apos;s terminal supports.  If there
                   is no terminal device available, a default value of 80 is
                   used.

           user_env
               The user&apos;s environment in the form of a NULL-terminated vector of
               &quot;name=value&quot; strings.

               When parsing user_env, the plugin should split on the first equal
               sign (&apos;=&apos;) since the name field will never include one itself but
               the value might.

           plugin_options
               Any (non-comment) strings immediately after the plugin path are
               treated as arguments to the plugin.  These arguments are split on
               a white space boundary and are passed to the plugin in the form
               of a NULL-terminated array of strings.  If no arguments were
               specified, plugin_options will be the NULL pointer.

               NOTE: the plugin_options parameter is only available starting
               with API version 1.2.  A plugin must check the API version
               specified by the sudo front end before using plugin_options.
               Failure to do so may result in a crash.

       close
            void (*close)(int exit_status, int error);

           The close function is called when the command being run by sudo
           finishes.

           The function arguments are as follows:

           exit_status
               The command&apos;s exit status, as returned by the wait(2) system
               call.  The value of exit_status is undefined if error is non-
               zero.

           error
               If the command could not be executed, this is set to the value of
               errno set by the execve(2) system call.  The plugin is
               responsible for displaying error information via the conversation
               or plugin_printf function.  If the command was successfully
               executed, the value of error is 0.

       show_version
            int (*show_version)(int verbose);

           The show_version function is called by sudo when the user specifies
           the -V option.  The plugin may display its version information to the
           user via the conversation or plugin_printf function using
           SUDO_CONV_INFO_MSG.  If the user requests detailed version
           information, the verbose flag will be set.

       check_policy
            int (*check_policy)(int argc, char * const argv[]
                                char *env_add[], char **command_info[],
                                char **argv_out[], char **user_env_out[]);

           The check_policy function is called by sudo to determine whether the
           user is allowed to run the specified commands.

           If the sudoedit option was enabled in the settings array passed to
           the open function, the user has requested sudoedit mode.  sudoedit is
           a mechanism for editing one or more files where an editor is run with
           the user&apos;s credentials instead of with elevated privileges.  sudo
           achieves this by creating user-writable temporary copies of the files
           to be edited and then overwriting the originals with the temporary
           copies after editing is complete.  If the plugin supports sudoedit,
           it should choose the editor to be used, potentially from a variable
           in the user&apos;s environment, such as EDITOR, and include it in argv_out
           (note that environment variables may include command line flags).
           The files to be edited should be copied from argv into argv_out,
           separated from the editor and its arguments by a &quot;--&quot; element.  The
           &quot;--&quot; will be removed by sudo before the editor is executed.  The
           plugin should also set sudoedit=true in the command_info list.

           The check_policy function returns 1 if the command is allowed, 0 if
           not allowed, -1 for a general error, or -2 for a usage error or if
           sudoedit was specified but is unsupported by the plugin.  In the
           latter case, sudo will print a usage message before it exits.  If an
           error occurs, the plugin may optionally call the conversation or
           plugin_printf function with SUDO_CONF_ERROR_MSG to present additional
           error information to the user.

           The function arguments are as follows:

           argc
               The number of elements in argv, not counting the final NULL
               pointer.

           argv
               The argument vector describing the command the user wishes to
               run, in the same form as what would be passed to the execve()
               system call.  The vector is terminated by a NULL pointer.

           env_add
               Additional environment variables specified by the user on the
               command line in the form of a NULL-terminated vector of
               &quot;name=value&quot; strings.  The plugin may reject the command if one
               or more variables are not allowed to be set, or it may silently
               ignore such variables.

               When parsing env_add, the plugin should split on the first equal
               sign (&apos;=&apos;) since the name field will never include one itself but
               the value might.

           command_info
               Information about the command being run in the form of
               &quot;name=value&quot; strings.  These values are used by sudo to set the
               execution environment when running a command.  The plugin is
               responsible for creating and populating the vector, which must be
               terminated with a NULL pointer.  The following values are
               recognized by sudo:

               command=string
                   Fully qualified path to the command to be executed.

               runas_uid=uid
                   User ID to run the command as.

               runas_euid=uid
                   Effective user ID to run the command as.  If not specified,
                   the value of runas_uid is used.

               runas_gid=gid
                   Group ID to run the command as.
&#12;               runas_egid=gid
                   Effective group ID to run the command as.  If not specified,
                   the value of runas_gid is used.

               runas_groups=list
                   The supplementary group vector to use for the command in the
                   form of a comma-separated list of group IDs.  If
                   preserve_groups is set, this option is ignored.

               login_class=string
                   BSD login class to use when setting resource limits and nice
                   value (optional).  This option is only set on systems that
                   support login classes.

               preserve_groups=bool
                   If set, sudo will preserve the user&apos;s group vector instead of
                   initializing the group vector based on runas_user.

               cwd=string
                   The current working directory to change to when executing the
                   command.

               noexec=bool
                   If set, prevent the command from executing other programs.

               chroot=string
                   The root directory to use when running the command.

               nice=int
                   Nice value (priority) to use when executing the command.  The
                   nice value, if specified, overrides the priority associated
                   with the login_class on BSD systems.

               umask=octal
                   The file creation mask to use when executing the command.

               selinux_role=string
                   SELinux role to use when executing the command.

               selinux_type=string
                   SELinux type to use when executing the command.

               timeout=int
                   Command timeout.  If non-zero then when the timeout expires
                   the command will be killed.

               sudoedit=bool
                   Set to true when in sudoedit mode.  The plugin may enable
                   sudoedit mode even if sudo was not invoked as sudoedit.  This
                   allows the plugin to perform command substitution and
                   transparently enable sudoedit when the user attempts to run
                   an editor.

               closefrom=number
                   If specified, sudo will close all files descriptors with a
                   value of number or higher.

               iolog_compress=bool
                   Set to true if the I/O logging plugins, if any, should
                   compress the log data.  This is a hint to the I/O logging
                   plugin which may choose to ignore it.

               iolog_path=string
                   Fully qualified path to the file or directory in which I/O
                   log is to be stored.  This is a hint to the I/O logging
                   plugin which may choose to ignore it.  If no I/O logging
                   plugin is loaded, this setting has no effect.

               iolog_stdin=bool
                   Set to true if the I/O logging plugins, if any, should log
                   the standard input if it is not connected to a terminal
                   device.  This is a hint to the I/O logging plugin which may
                   choose to ignore it.

               iolog_stdout=bool
                   Set to true if the I/O logging plugins, if any, should log
                   the standard output if it is not connected to a terminal
                   device.  This is a hint to the I/O logging plugin which may
                   choose to ignore it.

               iolog_stderr=bool
                   Set to true if the I/O logging plugins, if any, should log
                   the standard error if it is not connected to a terminal
                   device.  This is a hint to the I/O logging plugin which may
                   choose to ignore it.

               iolog_ttyin=bool
                   Set to true if the I/O logging plugins, if any, should log
                   all terminal input.  This only includes input typed by the
                   user and not from a pipe or redirected from a file.  This is
                   a hint to the I/O logging plugin which may choose to ignore
                   it.

               iolog_ttyout=bool
                   Set to true if the I/O logging plugins, if any, should log
                   all terminal output.  This only includes output to the
                   screen, not output to a pipe or file.  This is a hint to the
                   I/O logging plugin which may choose to ignore it.

               use_pty=bool
                   Allocate a pseudo-tty to run the command in, regardless of
                   whether or not I/O logging is in use.  By default, sudo will
                   only run the command in a pty when an I/O log plugin is
                   loaded.

               set_utmp=bool
                   Create a utmp (or utmpx) entry when a pseudo-tty is
                   allocated.  By default, the new entry will be a copy of the
                   user&apos;s existing utmp entry (if any), with the tty, time, type
                   and pid fields updated.

               utmp_user=string
                   User name to use when constructing a new utmp (or utmpx)
                   entry when set_utmp is enabled.  This option can be used to
                   set the user field in the utmp entry to the user the command
                   runs as rather than the invoking user.  If not set, sudo will
                   base the new entry on the invoking user&apos;s existing entry.

               Unsupported values will be ignored.

           argv_out
               The NULL-terminated argument vector to pass to the execve()
               system call when executing the command.  The plugin is
               responsible for allocating and populating the vector.

           user_env_out
               The NULL-terminated environment vector to use when executing the
               command.  The plugin is responsible for allocating and populating
               the vector.

       list
            int (*list)(int verbose, const char *list_user,
                        int argc, char * const argv[]);
&#12;           List available privileges for the invoking user.  Returns 1 on
           success, 0 on failure and -1 on error.  On error, the plugin may
           optionally call the conversation or plugin_printf function with
           SUDO_CONF_ERROR_MSG to present additional error information to the
           user.

           Privileges should be output via the conversation or plugin_printf
           function using SUDO_CONV_INFO_MSG.

           verbose
               Flag indicating whether to list in verbose mode or not.

           list_user
               The name of a different user to list privileges for if the policy
               allows it.  If NULL, the plugin should list the privileges of the
               invoking user.

           argc
               The number of elements in argv, not counting the final NULL
               pointer.

           argv
               If non-NULL, an argument vector describing a command the user
               wishes to check against the policy in the same form as what would
               be passed to the execve() system call.  If the command is
               permitted by the policy, the fully-qualified path to the command
               should be displayed along with any command line arguments.

       validate
            int (*validate)(void);

           The validate function is called when sudo is run with the -v flag.
           For policy plugins such as sudoers that cache authentication
           credentials, this function will validate and cache the credentials.

           The validate function should be NULL if the plugin does not support
           credential caching.

           Returns 1 on success, 0 on failure and -1 on error.  On error, the
           plugin may optionally call the conversation or plugin_printf function
           with SUDO_CONF_ERROR_MSG to present additional error information to
           the user.

       invalidate
            void (*invalidate)(int remove);

           The invalidate function is called when sudo is called with the -k or
           -K flag.  For policy plugins such as sudoers that cache
           authentication credentials, this function will invalidate the
           credentials.  If the remove flag is set, the plugin may remove the
           credentials instead of simply invalidating them.

           The invalidate function should be NULL if the plugin does not support
           credential caching.

       init_session
            int (*init_session)(struct passwd *pwd, char **user_envp[);

           The init_session function is called before sudo sets up the execution
           environment for the command.  It is run in the parent sudo process
           and before any uid or gid changes.  This can be used to perform
           session setup that is not supported by command_info, such as opening
           the PAM session.  The close function can be used to tear down the
           session that was opened by init_session.

           The pwd argument points to a passwd struct for the user the command
           will be run as if the uid the command will run as was found in the
           password database, otherwise it will be NULL.

           The user_env argument points to the environment the command will run
           in, in the form of a NULL-terminated vector of &quot;name=value&quot; strings.
           This is the same string passed back to the front end via the Policy
           Plugin&apos;s user_env_out parameter.  If the init_session function needs
           to modify the user environment, it should update the pointer stored
           in user_env.  The expected use case is to merge the contents of the
           PAM environment (if any) with the contents of user_env.  NOTE: the
           user_env parameter is only available starting with API version 1.2.
           A plugin must check the API version specified by the sudo front end
           before using user_env.  Failure to do so may result in a crash.

           Returns 1 on success, 0 on failure and -1 on error.  On error, the
           plugin may optionally call the conversation or plugin_printf function
           with SUDO_CONF_ERROR_MSG to present additional error information to
           the user.

       register_hooks
            void (*register_hooks)(int version,
               int (*register_hook)(struct sudo_hook *hook));

           The register_hooks function is called by the sudo front end to
           register any hooks the plugin needs.  If the plugin does not support
           hooks, register_hooks should be set to the NULL pointer.

           The version argument describes the version of the hooks API supported
           by the sudo front end.

           The register_hook function should be used to register any supported
           hooks the plugin needs.  It returns 0 on success, 1 if the hook type
           is not supported and -1 if the major version in struct hook does not
           match the front end&apos;s major hook API version.

           See the &quot;Hook Function API&quot; section below for more information about
           hooks.

           NOTE: the register_hooks function is only available starting with API
           version 1.2.  If the sudo front end doesn&apos;t support API version 1.2
           or higher, register_hooks will not be called.

       deregister_hooks
            void (*deregister_hooks)(int version,
               int (*deregister_hook)(struct sudo_hook *hook));

           The deregister_hooks function is called by the sudo front end to
           deregister any hooks the plugin has registered.  If the plugin does
           not support hooks, deregister_hooks should be set to the NULL
           pointer.

           The version argument describes the version of the hooks API supported
           by the sudo front end.

           The deregister_hook function should be used to deregister any hooks
           that were put in place by the register_hook function.  If the plugin
           tries to deregister a hook that the front end does not support,
           deregister_hook will return an error.

           See the &quot;Hook Function API&quot; section below for more information about
           hooks.

           NOTE: the deregister_hooks function is only available starting with
           API version 1.2.  If the sudo front end doesn&apos;t support API version
           1.2 or higher, deregister_hooks will not be called.

       Policy Plugin Version Macros
&#12;        /* Plugin API version major/minor. */
        #define SUDO_API_VERSION_MAJOR 1
        #define SUDO_API_VERSION_MINOR 2
        #define SUDO_API_MKVERSION(x, y) ((x &lt;&lt; 16) | y)
        #define SUDO_API_VERSION SUDO_API_MKVERSION(SUDO_API_VERSION_MAJOR,\
                                                    SUDO_API_VERSION_MINOR)

        /* Getters and setters for API version */
        #define SUDO_API_VERSION_GET_MAJOR(v) ((v) &gt;&gt; 16)
        #define SUDO_API_VERSION_GET_MINOR(v) ((v) &amp; 0xffff)
        #define SUDO_API_VERSION_SET_MAJOR(vp, n) do { \
            *(vp) = (*(vp) &amp; 0x0000ffff) | ((n) &lt;&lt; 16); \
        } while(0)
        #define SUDO_VERSION_SET_MINOR(vp, n) do { \
            *(vp) = (*(vp) &amp; 0xffff0000) | (n); \
        } while(0)

   I/O Plugin API
        struct io_plugin {
        #define SUDO_IO_PLUGIN         2
            unsigned int type; /* always SUDO_IO_PLUGIN */
            unsigned int version; /* always SUDO_API_VERSION */
            int (*open)(unsigned int version, sudo_conv_t conversation
                        sudo_printf_t plugin_printf, char * const settings[],
                        char * const user_info[], int argc, char * const argv[],
                        char * const user_env[], char * const plugin_options[]);
            void (*close)(int exit_status, int error); /* wait status or error */
            int (*show_version)(int verbose);
            int (*log_ttyin)(const char *buf, unsigned int len);
            int (*log_ttyout)(const char *buf, unsigned int len);
            int (*log_stdin)(const char *buf, unsigned int len);
            int (*log_stdout)(const char *buf, unsigned int len);
            int (*log_stderr)(const char *buf, unsigned int len);
            void (*register_hooks)(int version,
               int (*register_hook)(struct sudo_hook *hook));
            void (*deregister_hooks)(int version,
               int (*deregister_hook)(struct sudo_hook *hook));
        };

       When an I/O plugin is loaded, sudo runs the command in a pseudo-tty.
       This makes it possible to log the input and output from the user&apos;s
       session.  If any of the standard input, standard output or standard error
       do not correspond to a tty, sudo will open a pipe to capture the I/O for
       logging before passing it on.

       The log_ttyin function receives the raw user input from the terminal
       device (note that this will include input even when echo is disabled,
       such as when a password is read). The log_ttyout function receives output
       from the pseudo-tty that is suitable for replaying the user&apos;s session at
       a later time.  The log_stdin, log_stdout and log_stderr functions are
       only called if the standard input, standard output or standard error
       respectively correspond to something other than a tty.

       Any of the logging functions may be set to the NULL pointer if no logging
       is to be performed.  If the open function returns 0, no I/O will be sent
       to the plugin.

       The io_plugin struct has the following fields:

       type
           The type field should always be set to SUDO_IO_PLUGIN

       version
           The version field should be set to SUDO_API_VERSION.

           This allows sudo to determine the API version the plugin was built
           against.

       open
            int (*open)(unsigned int version, sudo_conv_t conversation
                        sudo_printf_t plugin_printf, char * const settings[],
                        char * const user_info[], int argc, char * const argv[],
                        char * const user_env[], char * const plugin_options[]);

           The open function is run before the log_input, log_output or
           show_version functions are called.  It is only called if the version
           is being requested or the check_policy function has returned
           successfully.  It returns 1 on success, 0 on failure, -1 if a general
           error occurred, or -2 if there was a usage error.  In the latter
           case, sudo will print a usage message before it exits.  If an error
           occurs, the plugin may optionally call the conversation or
           plugin_printf function with SUDO_CONF_ERROR_MSG to present additional
           error information to the user.

           The function arguments are as follows:

           version
               The version passed in by sudo allows the plugin to determine the
               major and minor version number of the plugin API supported by
               sudo.

           conversation
               A pointer to the conversation function that may be used by the
               show_version function to display version information (see
               show_version below).  The conversation function may also be used
               to display additional error message to the user.  The
               conversation function returns 0 on success and -1 on failure.

           plugin_printf
               A pointer to a printf-style function that may be used by the
               show_version function to display version information (see
               show_version below).  The plugin_printf function may also be used
               to display additional error message to the user.  The
               plugin_printf function returns number of characters printed on
               success and -1 on failure.

           settings
               A vector of user-supplied sudo settings in the form of
               &quot;name=value&quot; strings.  The vector is terminated by a NULL
               pointer.  These settings correspond to flags the user specified
               when running sudo.  As such, they will only be present when the
               corresponding flag has been specified on the command line.

               When parsing settings, the plugin should split on the first equal
               sign (&apos;=&apos;) since the name field will never include one itself but
               the value might.

               See the &quot;Policy Plugin API&quot; section for a list of all possible
               settings.

           user_info
               A vector of information about the user running the command in the
               form of &quot;name=value&quot; strings.  The vector is terminated by a NULL
               pointer.

               When parsing user_info, the plugin should split on the first
               equal sign (&apos;=&apos;) since the name field will never include one
               itself but the value might.

               See the &quot;Policy Plugin API&quot; section for a list of all possible
               strings.

           argc
               The number of elements in argv, not counting the final NULL
               pointer.

           argv
               If non-NULL, an argument vector describing a command the user
               wishes to run in the same form as what would be passed to the
               execve() system call.

           user_env
               The user&apos;s environment in the form of a NULL-terminated vector of
               &quot;name=value&quot; strings.

               When parsing user_env, the plugin should split on the first equal
               sign (&apos;=&apos;) since the name field will never include one itself but
               the value might.

           plugin_options
               Any (non-comment) strings immediately after the plugin path are
               treated as arguments to the plugin.  These arguments are split on
               a white space boundary and are passed to the plugin in the form
               of a NULL-terminated array of strings.  If no arguments were
               specified, plugin_options will be the NULL pointer.

               NOTE: the plugin_options parameter is only available starting
               with API version 1.2.  A plugin must check the API version
               specified by the sudo front end before using plugin_options.
               Failure to do so may result in a crash.

       close
            void (*close)(int exit_status, int error);

           The close function is called when the command being run by sudo
           finishes.

           The function arguments are as follows:

           exit_status
               The command&apos;s exit status, as returned by the wait(2) system
               call.  The value of exit_status is undefined if error is non-
               zero.

           error
               If the command could not be executed, this is set to the value of
               errno set by the execve(2) system call.  If the command was
               successfully executed, the value of error is 0.

       show_version
            int (*show_version)(int verbose);

           The show_version function is called by sudo when the user specifies
           the -V option.  The plugin may display its version information to the
           user via the conversation or plugin_printf function using
           SUDO_CONV_INFO_MSG.  If the user requests detailed version
           information, the verbose flag will be set.

       log_ttyin
            int (*log_ttyin)(const char *buf, unsigned int len);

           The log_ttyin function is called whenever data can be read from the
           user but before it is passed to the running command.  This allows the
           plugin to reject data if it chooses to (for instance if the input
           contains banned content).  Returns 1 if the data should be passed to
           the command, 0 if the data is rejected (which will terminate the
           command) or -1 if an error occurred.

           The function arguments are as follows:

           buf The buffer containing user input.

           len The length of buf in bytes.
&#12;       log_ttyout
            int (*log_ttyout)(const char *buf, unsigned int len);

           The log_ttyout function is called whenever data can be read from the
           command but before it is written to the user&apos;s terminal.  This allows
           the plugin to reject data if it chooses to (for instance if the
           output contains banned content).  Returns 1 if the data should be
           passed to the user, 0 if the data is rejected (which will terminate
           the command) or -1 if an error occurred.

           The function arguments are as follows:

           buf The buffer containing command output.

           len The length of buf in bytes.

       log_stdin
            int (*log_stdin)(const char *buf, unsigned int len);

           The log_stdin function is only used if the standard input does not
           correspond to a tty device.  It is called whenever data can be read
           from the standard input but before it is passed to the running
           command.  This allows the plugin to reject data if it chooses to (for
           instance if the input contains banned content).  Returns 1 if the
           data should be passed to the command, 0 if the data is rejected
           (which will terminate the command) or -1 if an error occurred.

           The function arguments are as follows:

           buf The buffer containing user input.

           len The length of buf in bytes.

       log_stdout
            int (*log_stdout)(const char *buf, unsigned int len);

           The log_stdout function is only used if the standard output does not
           correspond to a tty device.  It is called whenever data can be read
           from the command but before it is written to the standard output.
           This allows the plugin to reject data if it chooses to (for instance
           if the output contains banned content).  Returns 1 if the data should
           be passed to the user, 0 if the data is rejected (which will
           terminate the command) or -1 if an error occurred.

           The function arguments are as follows:

           buf The buffer containing command output.

           len The length of buf in bytes.

       log_stderr
            int (*log_stderr)(const char *buf, unsigned int len);

           The log_stderr function is only used if the standard error does not
           correspond to a tty device.  It is called whenever data can be read
           from the command but before it is written to the standard error.
           This allows the plugin to reject data if it chooses to (for instance
           if the output contains banned content).  Returns 1 if the data should
           be passed to the user, 0 if the data is rejected (which will
           terminate the command) or -1 if an error occurred.

           The function arguments are as follows:

           buf The buffer containing command output.

           len The length of buf in bytes.

       register_hooks
           See the &quot;Policy Plugin API&quot; section for a description of
           register_hooks.

       deregister_hooks
           See the &quot;Policy Plugin API&quot; section for a description of
           deregister_hooks.

       I/O Plugin Version Macros

       Same as for the &quot;Policy Plugin API&quot;.

   Hook Function API
       Beginning with plugin API version 1.2, it is possible to install hooks
       for certain functions called by the sudo front end.

       Currently, the only supported hooks relate to the handling of environment
       variables.  Hooks can be used to intercept attempts to get, set, or
       remove environment variables so that these changes can be reflected in
       the version of the environment that is used to execute a command.  A
       future version of the API will support hooking internal sudo front end
       functions as well.

       Hook structure

       Hooks in sudo are described by the following structure:

        typedef int (*sudo_hook_fn_t)();

        struct sudo_hook {
            int hook_version;
            int hook_type;
            sudo_hook_fn_t hook_fn;
            void *closure;
        };

       The sudo_hook structure has the following fields:

       hook_version
           The hook_version field should be set to SUDO_HOOK_VERSION.

       hook_type
           The hook_type field may be one of the following supported hook types:

           SUDO_HOOK_SETENV
               The C library setenv() function.  Any registered hooks will run
               before the C library implementation.  The hook_fn field should be
               a function that matches the following typedef:

                typedef int (*sudo_hook_fn_setenv_t)(const char *name,
                   const char *value, int overwrite, void *closure);

               If the registered hook does not match the typedef the results are
               unspecified.

           SUDO_HOOK_UNSETENV
               The C library unsetenv() function.  Any registered hooks will run
               before the C library implementation.  The hook_fn field should be
               a function that matches the following typedef:

                typedef int (*sudo_hook_fn_unsetenv_t)(const char *name,
                   void *closure);

           SUDO_HOOK_GETENV
               The C library getenv() function.  Any registered hooks will run
               before the C library implementation.  The hook_fn field should be
               a function that matches the following typedef:

                typedef int (*sudo_hook_fn_getenv_t)(const char *name,
                   char **value, void *closure);

               If the registered hook does not match the typedef the results are
               unspecified.

           SUDO_HOOK_PUTENV
               The C library putenv() function.  Any registered hooks will run
               before the C library implementation.  The hook_fn field should be
               a function that matches the following typedef:

                typedef int (*sudo_hook_fn_putenv_t)(char *string,
                   void *closure);

               If the registered hook does not match the typedef the results are
               unspecified.

       hook_fn
            sudo_hook_fn_t hook_fn;

           The hook_fn field should be set to the plugin&apos;s hook implementation.
           The actual function arguments will vary depending on the hook_type
           (see hook_type above).  In all cases, the closure field of struct
           sudo_hook is passed as the last function parameter.  This can be used
           to pass arbitrary data to the plugin&apos;s hook implementation.

           The function return value may be one of the following:

           SUDO_HOOK_RET_ERROR
               The hook function encountered an error.

           SUDO_HOOK_RET_NEXT
               The hook completed without error, go on to the next hook
               (including the native implementation if applicable).  For
               example, a getenv hook might return SUDO_HOOK_RET_NEXT if the
               specified variable was not found in the private copy of the
               environment.

           SUDO_HOOK_RET_STOP
               The hook completed without error, stop processing hooks for this
               invocation.  This can be used to replace the native
               implementation.  For example, a setenv hook that operates on a
               private copy of the environment but leaves environ unchanged.

       Note that it is very easy to create an infinite loop when hooking C
       library functions.  For example, a getenv hook that calls the snprintf
       function may create a loop if the snprintf implementation calls getenv to
       check the locale.  To prevent this, you may wish to use a static variable
       in the hook function to guard against nested calls.  E.g.

        static int in_progress = 0; /* avoid recursion */
        if (in_progress)
            return SUDO_HOOK_RET_NEXT;
        in_progress = 1;
        ...
        in_progress = 0;
        return SUDO_HOOK_RET_STOP;

       Hook API Version Macros

        /* Hook API version major/minor */
        #define SUDO_HOOK_VERSION_MAJOR 1
        #define SUDO_HOOK_VERSION_MINOR 0
        #define SUDO_HOOK_MKVERSION(x, y) ((x &lt;&lt; 16) | y)
        #define SUDO_HOOK_VERSION SUDO_HOOK_MKVERSION(SUDO_HOOK_VERSION_MAJOR,\
                                                      SUDO_HOOK_VERSION_MINOR)

        /* Getters and setters for hook API version */
        #define SUDO_HOOK_VERSION_GET_MAJOR(v) ((v) &gt;&gt; 16)
        #define SUDO_HOOK_VERSION_GET_MINOR(v) ((v) &amp; 0xffff)
        #define SUDO_HOOK_VERSION_SET_MAJOR(vp, n) do { \
            *(vp) = (*(vp) &amp; 0x0000ffff) | ((n) &lt;&lt; 16); \
        } while(0)
        #define SUDO_HOOK_VERSION_SET_MINOR(vp, n) do { \
            *(vp) = (*(vp) &amp; 0xffff0000) | (n); \
        } while(0)

   Conversation API
       If the plugin needs to interact with the user, it may do so via the
       conversation function.  A plugin should not attempt to read directly from
       the standard input or the user&apos;s tty (neither of which are guaranteed to
       exist).  The caller must include a trailing newline in msg if one is to
       be printed.

       A printf-style function is also available that can be used to display
       informational or error messages to the user, which is usually more
       convenient for simple messages where no use input is required.

        struct sudo_conv_message {
        #define SUDO_CONV_PROMPT_ECHO_OFF  0x0001 /* do not echo user input */
        #define SUDO_CONV_PROMPT_ECHO_ON   0x0002 /* echo user input */
        #define SUDO_CONV_ERROR_MSG        0x0003 /* error message */
        #define SUDO_CONV_INFO_MSG         0x0004 /* informational message */
        #define SUDO_CONV_PROMPT_MASK      0x0005 /* mask user input */
        #define SUDO_CONV_DEBUG_MSG        0x0006 /* debugging message */
        #define SUDO_CONV_PROMPT_ECHO_OK   0x1000 /* flag: allow echo if no tty */
            int msg_type;
            int timeout;
            const char *msg;
        };

        struct sudo_conv_reply {
            char *reply;
        };

        typedef int (*sudo_conv_t)(int num_msgs,
                     const struct sudo_conv_message msgs[],
                     struct sudo_conv_reply replies[]);

        typedef int (*sudo_printf_t)(int msg_type, const char *fmt, ...);

       Pointers to the conversation and printf-style functions are passed in to
       the plugin&apos;s open function when the plugin is initialized.

       To use the conversation function, the plugin must pass an array of
       sudo_conv_message and sudo_conv_reply structures.  There must be a struct
       sudo_conv_message and struct sudo_conv_reply for each message in the
       conversation.  The plugin is responsible for freeing the reply buffer
       filled in to the struct sudo_conv_reply, if any.

       The printf-style function uses the same underlying mechanism as the
       conversation function but only supports SUDO_CONV_INFO_MSG,
       SUDO_CONV_ERROR_MSG and SUDO_CONV_DEBUG_MSG for the msg_type parameter.
       It can be more convenient than using the conversation function if no user
       reply is needed and supports standard printf() escape sequences.

       Unlike, SUDO_CONV_INFO_MSG and SUDO_CONV_ERROR_MSG, messages sent with
       the &lt;SUDO_CONV_DEBUG_MSG&gt; msg_type are not directly user-visible.
       Instead, they are logged to the file specified in the Debug statement (if
       any) in the /etc/sudo.conf file.  This allows a plugin to log debugging
       information and is intended to be used in conjunction with the
       debug_flags setting.

       See the sample plugin for an example of the conversation function usage.

   Sudoers Group Plugin API
       The sudoers module supports a plugin interface to allow non-Unix group
       lookups.  This can be used to query a group source other than the
       standard Unix group database.  A sample group plugin is bundled with sudo
       that implements file-based lookups.  Third party group plugins include a
       QAS AD plugin available from Quest Software.

       A group plugin must declare and populate a sudoers_group_plugin struct in
       the global scope.  This structure contains pointers to the functions that
       implement plugin initialization, cleanup and group lookup.

        struct sudoers_group_plugin {
           unsigned int version;
           int (*init)(int version, sudo_printf_t sudo_printf,
                       char *const argv[]);
           void (*cleanup)(void);
           int (*query)(const char *user, const char *group,
                        const struct passwd *pwd);
       };

       The sudoers_group_plugin struct has the following fields:

       version
           The version field should be set to GROUP_API_VERSION.

           This allows sudoers to determine the API version the group plugin was
           built against.

       init
            int (*init)(int version, sudo_printf_t plugin_printf,
                        char *const argv[]);

           The init function is called after sudoers has been parsed but before
           any policy checks.  It returns 1 on success, 0 on failure (or if the
           plugin is not configured), and -1 if a error occurred.  If an error
           occurs, the plugin may call the plugin_printf function with
           SUDO_CONF_ERROR_MSG to present additional error information to the
           user.

           The function arguments are as follows:

           version
               The version passed in by sudoers allows the plugin to determine
               the major and minor version number of the group plugin API
               supported by sudoers.

           plugin_printf
               A pointer to a printf-style function that may be used to display
               informational or error message to the user.  Returns the number
               of characters printed on success and -1 on failure.

           argv
               A NULL-terminated array of arguments generated from the
               group_plugin option in sudoers.  If no arguments were given, argv
               will be NULL.

       cleanup
            void (*cleanup)();

           The cleanup function is called when sudoers has finished its group
           checks.  The plugin should free any memory it has allocated and close
           open file handles.

       query
            int (*query)(const char *user, const char *group,
                         const struct passwd *pwd);

           The query function is used to ask the group plugin whether user is a
           member of group.

           The function arguments are as follows:

           user
               The name of the user being looked up in the external group
               database.

           group
               The name of the group being queried.

           pwd The password database entry for user, if any.  If user is not
               present in the password database, pwd will be NULL.

       Group API Version Macros

        /* Sudoers group plugin version major/minor */
        #define GROUP_API_VERSION_MAJOR 1
        #define GROUP_API_VERSION_MINOR 0
        #define GROUP_API_VERSION ((GROUP_API_VERSION_MAJOR &lt;&lt; 16) | \
                                   GROUP_API_VERSION_MINOR)

        /* Getters and setters for group version */
        #define GROUP_API_VERSION_GET_MAJOR(v) ((v) &gt;&gt; 16)
        #define GROUP_API_VERSION_GET_MINOR(v) ((v) &amp; 0xffff)
        #define GROUP_API_VERSION_SET_MAJOR(vp, n) do { \
            *(vp) = (*(vp) &amp; 0x0000ffff) | ((n) &lt;&lt; 16); \
        } while(0)
        #define GROUP_API_VERSION_SET_MINOR(vp, n) do { \
            *(vp) = (*(vp) &amp; 0xffff0000) | (n); \
        } while(0)

PLUGIN API CHANGELOG
       The following revisions have been made to the Sudo Plugin API.

       Version 1.0
           Initial API version.

       Version 1.1
           The I/O logging plugin&apos;s open function was modified to take the
           command_info list as an argument.

       Version 1.2
           The Policy and I/O logging plugins&apos; open functions are now passed a
           list of plugin options if any are specified in /etc/sudo.conf.

           A simple hooks API has been introduced to allow plugins to hook in to
           the system&apos;s environment handling functions.

           The init_session Policy plugin function is now passed a pointer to
           the user environment which can be updated as needed.  This can be
           used to merge in environment variables stored in the PAM handle
           before a command is run.

SEE ALSO
       sudoers(5), sudo(8)

BUGS
       If you feel you have found a bug in sudo, please submit a bug report at
       http://www.sudo.ws/sudo/bugs/

SUPPORT
       Limited free support is available via the sudo-workers mailing list, see
       http://www.sudo.ws/mailman/listinfo/sudo-workers to subscribe or search
       the archives.

DISCLAIMER
       sudo is provided ``AS IS&apos;&apos; and any express or implied warranties,
       including, but not limited to, the implied warranties of merchantability
       and fitness for a particular purpose are disclaimed.  See the LICENSE
       file distributed with sudo or http://www.sudo.ws/sudo/license.html for
       complete details.



1.8.5                            April 23, 2012                   SUDO_PLUGIN(8)

</pre></body></html>
